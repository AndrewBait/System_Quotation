{% extends "base.html" %}

{% block content %}
<link href="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">

<style>
  .clickable {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    cursor: pointer;
  }

  .clickable:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  }


</style>


<div class="container mt-4">
  <h2 class="mb-4">Catálogo de Produtos</h2>
  <div class="row g-3 mb-4">
    <div class="col-md-12">
      <form method="GET" action="{% url 'products:products_list' %}" class="input-group">
        <input type="text" name="product_name" class="form-control" placeholder="Nome do Produto" value="{{ request.GET.product_name }}">
        <!-- Campos ocultos para os filtros -->
          <input type="hidden" name="department" value="{{ request.GET.department }}">
          <input type="hidden" name="category" value="{{ request.GET.category }}">
          <input type="hidden" name="subcategory" value="{{ request.GET.subcategory }}">
          <input type="hidden" name="status" value="{{ request.GET.status }}">
        <button type="submit" class="btn btn-outline-success">Buscar</button>
      </form>
    </div>
  <form method="GET" action="{% url 'products:products_list' %}"> 
    <div class="row g-2 mb-5">
      <div class="col-md-3">
        <select class="form-control" name="department" onchange="this.form.submit()">
          <option value="">Departamentos</option>
          {% for department in departments %}
          <option value="{{ department.id }}" {% if current_department == department.id|stringformat:"s" %} selected {% endif %}>
              {{ department.name }}
          </option>
          {% endfor %}
      </select>
    </div>
      <div class="col-md-3">
        <select class="form-select" name="category" onchange="this.form.submit()">
          <option value="">Categorias</option>
          {% for category in categories %}
          <option value="{{ category.id }}" {% if request.GET.category == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <select class="form-select" name="subcategory" onchange="this.form.submit()">
          <option value="">Subcategorias</option>
          {% for subcategory in subcategories %}
          <option value="{{ subcategory.id }}" {% if request.GET.subcategory == subcategory.id|stringformat:"s" %}selected{% endif %}>{{ subcategory.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <select class="form-select" name="status" onchange="this.form.submit()">
          <option value="">Qualquer Status</option>
          <option value="True" {% if request.GET.status == 'True' %}selected{% endif %}>Ativo</option>
          <option value="False" {% if request.GET.status == 'False' %}selected{% endif %}>Inativo</option>
        </select>
      </div>
      <div class="col-md-3">
        <select class="form-select" name="" onchange="this.form.submit()">
          <option value="">Marca</option>
        </select>
      </div>
      <div class="col-md-3">
        <select class="form-select" name="" onchange="this.form.submit()">
          <option value="">Linha</option>
        </select>
      </div>
    </div>
      <div class="text-end mt-3 ">
        <a href="{% url 'products:new_product' %}" class="btn btn-primary">
            <i class="bi bi-plus-lg"></i> Cadastrar Produto
        </a>
    </div>

    
    <!-- Filtros: Departamento, Categoria, Subcategoria, Status -->
    <!-- Se necessário, repita a estrutura para outros filtros -->
  </div>
  <div class="container">
    <!-- Outros conteúdos da página aqui -->
  
    <!-- Itens por página alinhados à esquerda -->
    <div class="row">
      <div class="col-auto">
        <div class="d-flex justify-content-start mb-4">
          <form action="" method="get" class="d-inline">
            <div class="input-group">
              <label class="input-group-text" for="items_per_page">Itens por página:</label>
              <select id="items_per_page" name="items_per_page" class="form-select" onchange="this.form.submit()">                
                <option value="20" {% if current_items_per_page == "20" %}selected{% endif %}>20</option>
                <option value="50" {% if current_items_per_page == "50" %}selected{% endif %}>50</option>
                <option value="100" {% if current_items_per_page == "100" %}selected{% endif %}>100</option>
              </select>
            </div>
          </form>
        </div>
      </div>
      <div class="col">
        <!-- Espaço reservado se necessário para conteúdo à direita do seletor -->
      </div>
    </div>
  </div>

  <div class="row row-cols-1 row-cols-md-5 g-4">
    {% for product in products %}
      <div class="col">
        <!-- Adiciona o atributo data-href com a URL de detalhe do produto -->
        <div class="card h-100 clickable" data-href="{% url 'products:product_detail' product.id %}">
          {% if product.photo %}
            <img src="{{ product.photo.url }}" class="card-img-top" alt="{{ product.name }}" style="max-height: 180px; object-fit: cover;">
          {% else %}
            <!-- Placeholder para quando não há imagem -->
            <svg class="bd-placeholder-img card-img-top" width="100%" height="180" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder: Thumbnail" preserveAspectRatio="xMidYMid slice" focusable="false">
              <title>Placeholder</title>
              <rect width="100%" height="100%" fill="#eee"/>
              <text x="50%" y="50%" fill="#aaa" dy=".3em" text-anchor="middle" dominant-baseline="middle">Sem imagem</text>
            </svg>
          {% endif %}
          <div class="card-body">
            <h5 class="card-title">{{ product.name }}</h5>
            {% if product.ean %}
            <p class="card-text">Código EAN: {{ product.ean }}</p>
            {% endif %}
            {% if product.sku %}
              <p class="card-text">SKU: {{ product.sku }}</p>
            {% endif %}
            <a href="{% url 'products:product_update' product.pk %}" class="btn btn-primary">Editar</a>
            <a href="{% url 'products:product_detail' product.pk %}" class="btn btn-info">Visualizar</a>
          </a>
          </div>
        </div>
      </div>

      <script>
        // Adiciona um event listener para capturar cliques na div .clickable
        document.querySelectorAll('.clickable').forEach(item => {
          item.addEventListener('click', event => {
            window.location.href = item.getAttribute('data-href');
          });
        });
      </script>
    {% endfor %}
  </div>

  {% if not products %}
    <p>Nenhum produto encontrado.</p>
  {% endif %}

  <nav aria-label="Page navigation example" class="mt-4">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}&items_per_page={{ current_items_per_page }}" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
      {% endif %}
      {% for num in page_obj.paginator.page_range %}
        <li class="page-item {% if page_obj.number == num %}active{% endif %}"><a class="page-link" href="?page={{ num }}&items_per_page={{ current_items_per_page }}">{{ num }}</a></li>
      {% endfor %}
      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}&items_per_page={{ current_items_per_page }}" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
      {% endif %}
    </ul>
  </nav>

  <div class="container">
    <!-- Outros conteúdos da página aqui -->
  
    <!-- Itens por página alinhados à direita -->
    <div class="row">
      <div class="col">
        <!-- Espaço reservado se necessário -->
      </div>
      <div class="col-auto">
        <div class="d-flex justify-content-end mb-4">
          <form action="" method="get" class="d-inline">
            <div class="input-group">
              <label class="input-group-text" for="items_per_page">Itens por página:</label>
              <select id="items_per_page" name="items_per_page" class="form-select" onchange="this.form.submit()">
                <option value="20" {% if current_items_per_page == "20" %}selected{% endif %}>20</option>
                <option value="50" {% if current_items_per_page == "50" %}selected{% endif %}>50</option>
                <option value="100" {% if current_items_per_page == "100" %}selected{% endif %}>100</option>
              </select>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
        var departmentSelect = document.querySelector('select[name="department"]');
        var categorySelect = document.querySelector('select[name="category"]');
        var subcategorySelect = document.querySelector('select[name="subcategory"]');
    
        departmentSelect.addEventListener('change', function() {       
            var departmentId = this.value;

            
            
            fetch(`/products/get-categories/?department_id=${departmentId}`)
                .then(response => response.json())
                .then(data => {
                    categorySelect.innerHTML = '<option value="">Todas as Categorias</option>';  
                    subcategorySelect.innerHTML = '<option value="">Todas as Subcategorias</option>';                  
                    data.forEach(function(category) {
                        var option = new Option(category.name, category.id);
                        categorySelect.add(option);
                    });
                });
        });
    
        categorySelect.addEventListener('change', function() {
            var categoryId = this.value;
            fetch(`/products/get-subcategories/?category_id=${categoryId}`)
                .then(response => response.json())
                .then(data => {
                    
                    subcategorySelect.innerHTML = '<option value="">Todas as Subcategorias</option>';
                    
                    data.forEach(function(subcategory) {
                        var option = new Option(subcategory.name, subcategory.id);
                        subcategorySelect.appendChild(option);
                    });
                });
        });
    });
    </script>   
    
    
    
</div>
{% endblock %}
