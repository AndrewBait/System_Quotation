{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h1>Adicionar Produtos à Cotação: {{ cotacao.nome }}</h1>

    <!-- Formulário de Pesquisa e Filtros -->
    <form method="get" class="mb-3">
        <div class="input-group mb-3">
            <input type="text" name="q" class="form-control" placeholder="Pesquisar produtos por nome, SKU ou EAN" value="{{ request.GET.q }}">
            <button class="btn btn-outline-secondary" type="submit">Buscar</button>
        </div>

        <div class="row mb-3">
            <div class="col-md-4">
                <select name="departamento_id" class="form-select" onchange="this.form.submit()">
                    <option value="">Todos os Departamentos</option>
                    {% for dept in departamentos %}
                    <option value="{{ dept.id }}" {% if dept.id == request.GET.departamento_id %}selected{% endif %}>{{ dept.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <select name="categoria_id" class="form-select" onchange="this.form.submit()">
                    <option value="">Selecione a Categoria</option>
                    {% for cat in categorias %}
                    <option value="{{ cat.id }}" {% if cat.id == request.GET.categoria_id %}selected{% endif %}>{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <select name="subcategoria_id" class="form-select" onchange="this.form.submit()">
                    <option value="">Selecione a Subcategoria</option>
                    {% for sub in subcategorias %}
                    <option value="{{ sub.id }}" {% if sub.id == request.GET.subcategoria_id %}selected{% endif %}>{{ sub.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </form>


    <form id="addProductsForm" method="post" action="{% url 'cotacao:add_products_to_cotacao' cotacao_id=cotacao.id %}">
        {% csrf_token %}
        <ul id="productList" class="list-group mb-4">
            {% for produto in produtos %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>{{ produto.name }}</span>
                <input type="number" name="quantidade-{{ produto.id }}" value="1" min="1" class="form-control me-2" style="width: 80px;">
                <select name="tipo_volume-{{ produto.id }}" class="form-select me-2" style="width: 150px;">
                    {% for code, name in tipo_volume_choices %}
                        <option value="{{ code }}">{{ name }}</option>
                    {% endfor %}
                </select>
                <button type="button" class="btn btn-primary add-product" data-product-id="{{ produto.id }}">Adicionar</button>
            </li>
            {% endfor %}
        </ul>
    </form>
    <!-- Lista de Produtos Selecionados -->
<!-- Lista de Produtos Selecionados -->
<div class="container mt-4">
    <h2 class="mb-3">Produtos Selecionados</h2>
    <form id="selectedProductsForm" method="post" action="{% url 'cotacao:add_products_to_cotacao' cotacao_id=cotacao.id %}">
        {% csrf_token %}
        <ul id="selectedProducts" class="list-group mb-4">
            {% for item in itens_cotacao %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div class="flex-grow-1 me-3">
                    <strong>{{ item.produto.name }}</strong>
                </div>
                <input type="number" name="quantidade-{{ item.produto.id }}" value="{{ item.quantidade }}" class="form-control me-2" style="width: 80px;">
                <select name="tipo_volume-{{ item.produto.id }}" class="form-select me-2" style="width: 150px;">
                    {% for code, name in item_cotacao_form.fields.tipo_volume.choices %}
                        <option value="{{ code }}" {% if code == item.tipo_volume %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeProduct('{{ item.produto.id }}')">Remover</button>
            </li>
            {% endfor %}
        </ul>
        <div class="mb-3">
            <textarea name="observacoes" class="form-control" placeholder="Adicione observações aqui..." rows="3"></textarea>
        </div>
        <button type="submit" class="btn btn-success">Salvar Cotação</button>
    </form>
</div>


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.add-product').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            const li = this.parentNode;
            const quantity = li.querySelector(`input[name="quantidade-${productId}"]`).value;
            const volumeType = li.querySelector(`select[name="tipo_volume-${productId}"]`).value;

            const selectedList = document.getElementById('selectedProducts');
            const newLi = document.createElement('li');
            newLi.className = 'list-group-item d-flex justify-content-between align-items-center';
            newLi.innerHTML = `
                <div class="flex-grow-1 me-3">
                    <strong>${li.querySelector('span').textContent}</strong>
                </div>
                <input type="number" name="quantidade-${productId}" value="${quantity}" class="form-control me-2" style="width: 80px;">
                <select name="tipo_volume-${productId}" class="form-select me-2" style="width: 150px;">` +
                    Array.from(li.querySelector(`select[name="tipo_volume-${productId}"]`).options).map(option => `<option value="${option.value}" ${option.value === volumeType ? 'selected' : ''}>${option.text}</option>`).join('') +
                `</select>
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentNode.remove()">Remover</button>`;
            selectedList.appendChild(newLi);
            this.disabled = true; // Opcional: desabilita o botão após adicionar
        });
    });

            if (!document.querySelector(`#product-${productId}`)) {
                const listItem = document.createElement('li');
                listItem.id = `product-${productId}`;
                listItem.className = 'list-group-item d-flex justify-content-between align-items-center';

                const productNameDiv = document.createElement('div');
                productNameDiv.className = 'flex-grow-1 me-3';
                productNameDiv.textContent = productName;
                listItem.appendChild(productNameDiv);

                const inputQuantity = document.createElement('input');
                inputQuantity.type = 'number';
                inputQuantity.name = `quantidade-${productId}`;
                inputQuantity.value = '1';
                inputQuantity.min = '1';
                inputQuantity.className = 'form-control me-2';
                inputQuantity.style.width = '80px';
                listItem.appendChild(inputQuantity);

                const selectTipoVolume = document.createElement('select');
                selectTipoVolume.name = `tipo_volume-${productId}`;
                selectTipoVolume.className = 'form-select me-2';
                selectTipoVolume.style.width = '150px';
                tipoVolumeChoices.forEach(function(choice) {
                    let option = new Option(choice.name, choice.code);
                    selectTipoVolume.options.add(option);
                });
                listItem.appendChild(selectTipoVolume);

                const buttonRemove = document.createElement('button');
                buttonRemove.type = 'button';
                buttonRemove.className = 'btn btn-danger btn-sm';
                buttonRemove.textContent = 'Remover';
                buttonRemove.onclick = function() { listItem.remove(); };
                listItem.appendChild(buttonRemove);

                document.getElementById('selectedProducts').appendChild(listItem);
            }
        });
    });
});

</script>
{% endblock %}

{% endblock %}
