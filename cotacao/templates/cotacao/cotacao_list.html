
{% load static crispy_forms_tags %}

{% block content %}
<div class="container mt-4">
    <form method="get" class="search-form">
        <input type="hidden" name="tab" value="list" />
        <!-- Campos de Filtro -->
        <div class="row">
            <div class="col">
                <input type="date" name="data_inicio" class="form-control" value="{{ request.GET.data_inicio }}" placeholder="De:">
            </div>
            <div class="col">
                <input type="date" name="data_fim" class="form-control" value="{{ request.GET.data_fim }}" placeholder="Até:">
            </div>
            <div class="col">
                <select name="status" class="form-control" id="status-filter">
                    <option value="">Todos os Status</option>
                    <option value="ativo" {% if request.GET.status == 'ativo' %}selected{% endif %}>Ativo</option>
                    <option value="inativo" {% if request.GET.status == 'inativo' %}selected{% endif %}>Inativo</option>
                </select>
            </div>
            <div class="col">
                <select name="usuario" class="form-control" id="user-filter">
                    <option value="">Todos os Usuários</option>
                    {% for usuario in usuarios %}
                    <option value="{{ usuario.id }}" {% if request.GET.usuario == usuario.id|stringformat:"s" %}selected{% endif %}>{{ usuario.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col">
                <select name="departamento" class="form-control" id="department-filter">
                    <option value="">Todos os Departamentos</option>
                    {% for departamento in departamentos %}
                    <option value="{{ departamento.id }}" {% if request.GET.departamento == departamento.id|stringformat:"s" %}selected{% endif %}>{{ departamento.nome }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </form>
    <!-- Include JavaScript to auto-submit on changes -->
    <script>
        document.getElementById('status-filter').addEventListener('change', function() {
            this.form.submit();
        });
        document.getElementById('user-filter').addEventListener('change', function() {
            this.form.submit();
        });
        document.getElementById('department-filter').addEventListener('change', function() {
            this.form.submit();
        });
    </script>

    <!-- Lista de Cotações -->
    <div class="list-group mt-4">
        {% for cotacao in cotacoes %}
        <div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
                <h5>{{ cotacao.nome }} - {{ cotacao.departamento.nome }}</h5>
                <p>Criado por: {{ cotacao.usuario_criador.username }} </p>
                <p>Aberta em: {{ cotacao.data_abertura }}  </p>
                <p>Fechamento em: {{ cotacao.data_fechamento }}   </p>
                <p>Status: {{ cotacao.get_status_display }} </p>
                <p>Prazo: {{ cotacao.prazo }} dias</p>
            </div>
            <div>
                <a href="{% url 'cotacao:toggle_cotacao_status' cotacao.id %}" class="btn btn-secondary">{{ cotacao.get_status_display }}</a>
                <a href="{% url 'cotacao:edit_cotacao' cotacao.id %}" class="btn btn-warning">Editar</a>
                <a href="{% url 'cotacao:add_product_to_cotacao' cotacao.id %}" class="btn btn-primary">Adicionar Produtos</a>
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteCotacaoModal{{ cotacao.id }}">Excluir Cotação</button>
            </div>
        </div>
        {% empty %}
        <p class="text-muted">Não há cotações cadastradas no momento.</p>
        {% endfor %}
    </div>
</div>

{% for cotacao in cotacoes %}
<!-- Modal de Exclusão -->
<div class="modal fade" id="deleteCotacaoModal{{ cotacao.id }}" tabindex="-1" role="dialog" aria-labelledby="deleteCotacaoModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteCotacaoModalLabel">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Tem certeza que deseja excluir esta cotação "{{ cotacao.nome }}"?
            </div>
            <div class="modal-footer">
                <form method="post" action="{% url 'cotacao:delete_cotacao' cotacao.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Excluir</button>
                </form>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}
