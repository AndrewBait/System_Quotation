{% extends 'base_no.html' %}
{% load static %}
{% block content %}
<form method="post" action="{% url 'respostas:gerar_pedidos' %}" id="gerar-pedidos-form">
    {% csrf_token %}
    <input type="hidden" name="cotacao_uuid" value="{{ cotacao.uuid }}">  

    <div class="container-fluid mt-4">    
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Respostas para Cotação: {{ cotacao.nome }}</h2>

            {# Mensagens de sucesso usando alert-dismissible para permitir o fechamento #}
            {% if messages %}
                {% for message in messages %}
                    {% if message.tags == 'success' %}
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
            
            <div class="d-flex flex-wrap">
                <a href="{% url 'cotacao:cotacao_list' %}" class="btn btn-secondary me-2">
                    <i class="bi bi-arrow-left"></i> Voltar
                </a>
                <button type="button" class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#fecharCotacaoModal">
                    Fechar Cotação
                </button> 
                <a href="{% url 'respostas:listar_pedidos' %}" class="btn btn-primary">Visualizar Pedidos</a>
            </div>
        </div>

        {# Filtros e Ordenação #}
        <div class="row mb-3">
            <div class="col-md-6">
                <input class="form-control" id="searchInput" type="text" placeholder="Pesquisar por nome do produto...">
            </div>
            <div class="col-md-3">
                <select class="form-select" id="filterSelect">
                    <option value="">Ordenar por Nome</option>
                    <option value="asc">A - Z</option>
                    <option value="desc">Z - A</option>
                </select>
            </div>
            <div class="col-md-3"></div> 
        </div>

        {# Tabela de Respostas #}
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="productsTable">
                <thead>
                    <tr>
                        <th>Quantidade</th>
                        <th>Tipo de Volume</th>
                        <th>Produto</th>                   
                        <th>Último Preço</th>
                        <th>Top 3 Ofertas</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in itens_data %}
                        {% if item.respostas %}
                        <tr data-produto="{{ item.produto_nome }}"> 
                            <td>{{ item.quantidade }}</td>
                            <td>{{ item.tipo_volume }}</td>
                            <td class="text-truncate" style="max-width: 200px;">{{ item.produto_nome }}</td>
                            
                            <td>
                                R$ {{ item.ultimo_preco }} em {{ item.data_ultimo_preco|date:"d/m/Y" }} <br>
                                <button type="button" class="btn btn-link" data-bs-toggle="modal" data-bs-target="#priceHistoryModal{{ forloop.counter }}">
                                    Ver Histórico
                                </button>
                            </td>

                            {# Modal Histórico de Preços #}
                            {% include 'modals/price_history_modal.html' with forloop=forloop item=item %}

                            <td>
                                <ul class="list-unstyled">
                                    {% for resposta in item.respostas|slice:":3" %}
                                        {% include 'modals/offer_details_modal.html' with resposta=resposta item=item forloop=forloop %}
                                    {% endfor %}
                                </ul>
                                {% if item.respostas|length > 3 %}
                                    <button type="button" class="btn btn-link" data-bs-toggle="modal" data-bs-target="#moreOffersModal{{ item.id }}">
                                        Ver mais {{ item.respostas|length|add:"-3" }} ofertas
                                    </button>
                                    {% include 'modals/more_offers_modal.html' with item=item %}
                                {% endif %}
                            </td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {# Controles de Paginação #}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center" id="pagination">
                <li class="page-item disabled">
                    <a class="page-link" href="#" tabindex="-1" id="prevPage">Anterior</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="#" id="nextPage">Próxima</a>
                </li>
            </ul>
        </nav>
    </div>

    {# Modal de Confirmação de Pedidos #}
    {% include 'modals/success_modal.html' %}
    {# Modal de Confirmação para Fechar Cotação #}
    {% include 'modals/fechar_cotacao_modal.html' %}
</form>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/cotacao.js' %}"></script>
<script>
    // Configurações da paginação
    const rowsPerPage = 10;
    let currentPage = 1;
    const rows = document.querySelectorAll('#productsTable tbody tr');
    const rowsCount = rows.length;
    const pageCount = Math.ceil(rowsCount / rowsPerPage);
    const pagination = document.getElementById('pagination');

    // Função para exibir uma página específica
    function displayPage(page) {
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;

        rows.forEach((row, index) => {
            row.style.display = index >= start && index < end ? '' : 'none';
        });

        currentPage = page;

        document.querySelectorAll('.page-item').forEach(item => {
            item.classList.remove('active');
        });

        const pageItem = document.querySelector(`#page${page}`);
        if (pageItem) {
            pageItem.classList.add('active');
        }

        document.getElementById('prevPage').parentNode.classList.toggle('disabled', currentPage === 1);
        document.getElementById('nextPage').parentNode.classList.toggle('disabled', currentPage === pageCount);
    }

    // Adiciona os itens de paginação
    for (let i = 1; i <= pageCount; i++) {
        const li = document.createElement('li');
        li.className = 'page-item';
        li.innerHTML = `<a class="page-link" href="#" id="page${i}">${i}</a>`;
        li.addEventListener('click', (e) => {
            e.preventDefault();
            displayPage(i);
        });
        pagination.insertBefore(li, document.getElementById('nextPage').parentNode);
    }

    // Eventos dos botões de próxima e anterior
    document.getElementById('prevPage').addEventListener('click', (e) => {
        e.preventDefault();
        if (currentPage > 1) {
            displayPage(currentPage - 1);
        }
    });

    document.getElementById('nextPage').addEventListener('click', (e) => {
        e.preventDefault();
        if (currentPage < pageCount) {
            displayPage(currentPage + 1);
        }
    });

    // Exibe a primeira página ao carregar
    displayPage(1);
</script>
{% endblock %}
